import { Discord, Slash, Guard } from "discordx";
import { CommandInteraction, AttachmentBuilder } from "discord.js";
import { Cooldown } from "../utils/decorators/CoommandCooldown.js";
import { ChannelGuard } from "../utils/decorators/ChannelGuard.js";
import { generateBasicSkillTreeImage, generateDemoSkills } from "../utils/drawSkillTree.js";
import logger from "../services/logger.js";

@Discord()
export class SkillTreeCommand {
    @Slash({
        name: "skilltree",
        description: "–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–µ—Ä–µ–≤–æ –Ω–∞–≤—ã–∫–æ–≤"
    })
    @Guard(
        ChannelGuard("user_commands_channel"),
        Cooldown({ seconds: 10 })
    )
    async skilltree(interaction: CommandInteraction): Promise<void> {
        try {
            // –°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥—Ä—É–∑–∫–µ
            await interaction.deferReply();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–≤—ã–∫–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –æ–ø–∏—Å–∞–Ω–∏—é
            const skillsData = generateDemoSkills();
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –¥–µ—Ä–µ–≤–æ–º –Ω–∞–≤—ã–∫–æ–≤
            const imageBuffer = await generateBasicSkillTreeImage(skillsData);
            
            // –°–æ–∑–¥–∞–µ–º –≤–ª–æ–∂–µ–Ω–∏–µ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const attachment = new AttachmentBuilder(imageBuffer, { name: 'skill-tree.png' });
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            await interaction.editReply({
                content: 'üå≥ –í–æ—Ç –≤–∞—à–µ –¥–µ—Ä–µ–≤–æ –Ω–∞–≤—ã–∫–æ–≤:\n–í –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –≤—ã —Å–º–æ–∂–µ—Ç–µ –ø—Ä–æ–∫–∞—á–∏–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.',
                files: [attachment]
            });
            
            logger.info(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${interaction.user.tag} –∑–∞–ø—Ä–æ—Å–∏–ª –¥–µ—Ä–µ–≤–æ –Ω–∞–≤—ã–∫–æ–≤`);
        } catch (error) {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
            logger.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–µ—Ä–µ–≤–∞ –Ω–∞–≤—ã–∫–æ–≤:', error);
            
            await interaction.editReply({
                content: '‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–µ—Ä–µ–≤–∞ –Ω–∞–≤—ã–∫–æ–≤. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.'
            });
        }
    }
}